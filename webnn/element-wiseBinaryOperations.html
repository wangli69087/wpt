<!doctype html>
<meta charset=utf-8>
<title>element-wise binary operations</title>
<link rel=help href=https://webmachinelearning.github.io/webnn/#api-neuralnetworkcontext-binary>
<script src=../resources/testharness.js></script>
<script src=../resources/testharnessreport.js></script>
<script src=./utils.js></script>
<script src=./dist/webnn-polyfill.js></script>

<div id=log></div>
<script>
  'use strict';
  let nn;
  setup(() => {
    nn = navigator.ml.getNeuralNetworkContext();
  })

  promise_test(async t => {
    const a = nn.input('a', {type: 'tensor-float32', dimensions: [3, 4, 5]});
    const b = nn.constant(
        {type: 'tensor-float32', dimensions: [3, 4, 5]}, new Float32Array([
          -0.5781865,  -0.49248728, -0.2162451,  -0.13176449, -0.52118045,
          1.9125274,   0.6508799,   0.71873736,  -2.3154447,  0.8080079,
          0.3022368,   0.21394566,  -0.6511544,  0.20001237,  -0.08041809,
          1.1127822,   -1.521739,   0.7249548,   -0.91961324, -0.83175105,
          -1.4569077,  -0.5417681,  -1.6476909,  0.1223801,   2.220618,
          -0.14914903, 0.7790501,   -0.18711103, -0.9941537,  -1.828552,
          -1.36035,    0.5727087,   2.5213664,   -0.3267195,  0.8431539,
          0.12337407,  1.0018097,   -0.23469485, -0.4530751,  0.09238022,
          0.7888511,   0.11107288,  0.48171726,  0.34308678,  -0.90550417,
          0.203841,    0.02521433,  -1.7966009,  -1.4287543,  0.3222213,
          1.0590587,   -1.7948701,  -1.7195907,  -0.9120889,  -0.9391962,
          -0.2566791,  -0.5464537,  1.4351872,   0.5705938,   -0.30327085,
        ]));
    const output = nn.add(a, b);
    const model = await nn.createModel([{name: 'output', operand: output}]);
    const compilation = await model.createCompilation();
    const execution = await compilation.createExecution();
    execution.setInput(
        'a', new Float32Array([
          0.08939514,  -1.5887482,  0.8545348,   0.20523034,  -0.41728342,
          1.01752,     0.19677015,  0.5398451,   0.56893295,  1.2511084,
          2.0092728,   1.0606714,   0.4893267,   0.09536829,  -2.3467007,
          2.4527607,   0.61307395,  -1.0799897,  -0.15071101, -0.48422927,
          -0.20479254, 0.32798728,  -0.37435308, -1.7116562,  1.6952512,
          -0.7479369,  -0.09019202, 0.14343949,  1.6754607,   1.6427531,
          0.9470988,   0.20872667,  -1.9530525,  -0.21783416, 0.0309498,
          0.3008434,   1.1686599,   1.4920886,   0.06633294,  0.6674667,
          0.60627925,  0.04302086,  -0.03482966, -0.7343786,  -0.76851964,
          0.9446942,   -0.35489243, 0.44452578,  0.00648887,  -0.55656946,
          -0.735903,   0.22050636,  -0.5008282,  -1.3132697,  1.6642882,
          -0.48397836, 0.20099205,  -0.28786168, 1.3315053,   -0.41619393,
        ]));
    const outputBuffer = new Float32Array(60);
    execution.setOutput('output', outputBuffer);
    await execution.startCompute();
    const expected = [
      -0.48879138, -2.0812354,  0.6382897,   0.07346585,  -0.93846387,
      2.9300475,   0.84765005,  1.2585825,   -1.7465117,  2.0591164,
      2.3115096,   1.2746171,   -0.16182771, 0.29538065,  -2.4271188,
      3.565543,    -0.90866506, -0.3550349,  -1.0703243,  -1.3159803,
      -1.6617002,  -0.21378079, -2.022044,   -1.5892761,  3.9158692,
      -0.8970859,  0.6888581,   -0.04367155, 0.681307,    -0.18579888,
      -0.41325122, 0.7814354,   0.56831384,  -0.54455364, 0.8741037,
      0.42421746,  2.1704698,   1.2573937,   -0.38674217, 0.7598469,
      1.3951304,   0.15409374,  0.4468876,   -0.3912918,  -1.6740239,
      1.1485353,   -0.32967812, -1.3520751,  -1.4222654,  -0.23434815,
      0.32315564,  -1.5743638,  -2.220419,   -2.2253585,  0.72509193,
      -0.74065745, -0.34546167, 1.1473255,   1.9020991,   -0.7194648,
    ];
    checkOutput(outputBuffer, expected);
  }, "Add: Compute the element-wise binary addition with two input tensors, one input tensors is a constant.");

  promise_test(async t => {
    const a = nn.input('a', {type: 'tensor-float32', dimensions: [3, 4, 5]});
    const b = nn.input('b', {type: 'tensor-float32', dimensions: [3, 4, 5]});
    const output = nn.add(a, b);
    const model = await nn.createModel([{name: 'output', operand: output}]);
    const compilation = await model.createCompilation();
    const execution = await compilation.createExecution();
    execution.setInput(
        'a', new Float32Array([
          0.08939514,  -1.5887482,  0.8545348,   0.20523034,  -0.41728342,
          1.01752,     0.19677015,  0.5398451,   0.56893295,  1.2511084,
          2.0092728,   1.0606714,   0.4893267,   0.09536829,  -2.3467007,
          2.4527607,   0.61307395,  -1.0799897,  -0.15071101, -0.48422927,
          -0.20479254, 0.32798728,  -0.37435308, -1.7116562,  1.6952512,
          -0.7479369,  -0.09019202, 0.14343949,  1.6754607,   1.6427531,
          0.9470988,   0.20872667,  -1.9530525,  -0.21783416, 0.0309498,
          0.3008434,   1.1686599,   1.4920886,   0.06633294,  0.6674667,
          0.60627925,  0.04302086,  -0.03482966, -0.7343786,  -0.76851964,
          0.9446942,   -0.35489243, 0.44452578,  0.00648887,  -0.55656946,
          -0.735903,   0.22050636,  -0.5008282,  -1.3132697,  1.6642882,
          -0.48397836, 0.20099205,  -0.28786168, 1.3315053,   -0.41619393,
        ]));
    execution.setInput(
        'b', new Float32Array([
          -0.5781865,  -0.49248728, -0.2162451,  -0.13176449, -0.52118045,
          1.9125274,   0.6508799,   0.71873736,  -2.3154447,  0.8080079,
          0.3022368,   0.21394566,  -0.6511544,  0.20001237,  -0.08041809,
          1.1127822,   -1.521739,   0.7249548,   -0.91961324, -0.83175105,
          -1.4569077,  -0.5417681,  -1.6476909,  0.1223801,   2.220618,
          -0.14914903, 0.7790501,   -0.18711103, -0.9941537,  -1.828552,
          -1.36035,    0.5727087,   2.5213664,   -0.3267195,  0.8431539,
          0.12337407,  1.0018097,   -0.23469485, -0.4530751,  0.09238022,
          0.7888511,   0.11107288,  0.48171726,  0.34308678,  -0.90550417,
          0.203841,    0.02521433,  -1.7966009,  -1.4287543,  0.3222213,
          1.0590587,   -1.7948701,  -1.7195907,  -0.9120889,  -0.9391962,
          -0.2566791,  -0.5464537,  1.4351872,   0.5705938,   -0.30327085,
        ]));
    const outputBuffer = new Float32Array(60);
    execution.setOutput('output', outputBuffer);
    await execution.startCompute();
    const expected = [
      -0.48879138, -2.0812354,  0.6382897,   0.07346585,  -0.93846387,
      2.9300475,   0.84765005,  1.2585825,   -1.7465117,  2.0591164,
      2.3115096,   1.2746171,   -0.16182771, 0.29538065,  -2.4271188,
      3.565543,    -0.90866506, -0.3550349,  -1.0703243,  -1.3159803,
      -1.6617002,  -0.21378079, -2.022044,   -1.5892761,  3.9158692,
      -0.8970859,  0.6888581,   -0.04367155, 0.681307,    -0.18579888,
      -0.41325122, 0.7814354,   0.56831384,  -0.54455364, 0.8741037,
      0.42421746,  2.1704698,   1.2573937,   -0.38674217, 0.7598469,
      1.3951304,   0.15409374,  0.4468876,   -0.3912918,  -1.6740239,
      1.1485353,   -0.32967812, -1.3520751,  -1.4222654,  -0.23434815,
      0.32315564,  -1.5743638,  -2.220419,   -2.2253585,  0.72509193,
      -0.74065745, -0.34546167, 1.1473255,   1.9020991,   -0.7194648,
    ];
    checkOutput(outputBuffer, expected);
  }, "Add: Compute the element-wise binary addition with two input tensors.");

  promise_test(async t => {
      const a = nn.input('a', {type: 'tensor-float32', dimensions: [3, 4, 5]});
      const b = nn.input('b', {type: 'tensor-float32', dimensions: [5]});
      const output = nn.add(a, b);
      const model = await nn.createModel([{name: 'output', operand: output}]);
      const compilation = await model.createCompilation();
      const execution = await compilation.createExecution();
      execution.setInput(
          'a', new Float32Array([
            -0.08539673, 0.11800674,  -1.2358714,  0.30089188,  -0.73443925,
            1.4894297,   0.16823359,  -2.2034893,  1.0740992,   -0.35457978,
            0.61524934,  0.462153,    0.5992003,   -0.81047946, -2.2757835,
            -0.21841764, 1.1650828,   -0.56927145, 1.9960726,   0.62048405,
            0.10586528,  -1.0386543,  -1.9402571,  -2.0906122,  -0.4305259,
            -1.2730165,  1.5639576,   0.53357494,  -0.8079486,  -0.06450062,
            -0.7841324,  -0.24135855, 1.9275267,   0.4476717,   0.15467685,
            -1.2363592,  -0.50745815, 0.03250425,  0.86344534,  -0.7938714,
            1.1835734,   1.515135,    0.3092435,   -1.311751,   -0.6659017,
            0.8815683,   -0.31157655, 0.57511795,  -1.1924151,  -1.8408557,
            -0.85080767, -1.3341717,  0.54687303,  -0.14426671, -0.15728855,
            0.323939,    1.167636,    0.03020451,  0.91373825,  1.0675793,
          ]));
      execution.setInput('b', new Float32Array([
                          0.6338172,
                          1.630534,
                          -1.3819867,
                          -1.0427561,
                          1.058136,
                        ]));
      const outputBuffer = new Float32Array(60);
      execution.setOutput('output', outputBuffer);
      await execution.startCompute();
      const expected = [
        0.5484205,   1.7485408, -2.6178582, -0.7418642,  0.32369673,
        2.123247,    1.7987677, -3.585476,  0.0313431,   0.7035562,
        1.2490666,   2.0926871, -0.7827864, -1.8532355,  -1.2176476,
        0.41539955,  2.7956169, -1.9512582, 0.95331657,  1.6786201,
        0.7396825,   0.5918797, -3.3222437, -3.1333683,  0.6276101,
        -0.63919926, 3.1944916, -0.8484118, -1.8507047,  0.99363536,
        -0.15031523, 1.3891755, 0.54554,    -0.59508437, 1.2128129,
        -0.60254204, 1.123076,  -1.3494825, -0.17931074, 0.26426458,
        1.8173906,   3.145669,  -1.0727432, -2.354507,   0.39223427,
        1.5153855,   1.3189576, -0.8068688, -2.2351713,  -0.78271973,
        -0.21699047, 0.2963624, -0.8351137, -1.1870228,  0.90084743,
        0.95775616,  2.79817,   -1.3517822, -0.12901783, 2.1257153,
      ];
      checkOutput(outputBuffer, expected);
  }, "Add: Compute the element-wise binary addition with two input tensors whose dimensions are compatible.");

  promise_test(async t => {
    const a = nn.input('a', {type: 'tensor-float32', dimensions: [3, 4, 5]});
    const b = nn.constant(
        {type: 'tensor-float32', dimensions: [3, 4, 5]}, new Float32Array([
          2.0435283,  0.07213961,  -1.1644137,  -1.2209045,  0.8982674,
          0.21796915, 0.27658972,  0.7744382,   -0.52159035, -0.969913,
          0.6081186,  -0.04225572, 0.3275312,   -0.06443629, -2.257355,
          1.7802691,  -1.279233,   -3.1389477,  -1.1663845,  -0.79485595,
          0.679013,   1.0919031,   0.51905185,  1.3186365,   0.6612518,
          0.40741763, 0.05208012,  0.16548257,  -0.4570541,  0.10149371,
          0.08249464, 0.3992067,   -0.3945879,  -0.37389037, 1.4760005,
          -0.781274,  -0.49022308, 0.27020553,  -0.2356837,  0.13846985,
          0.9767852,  -1.3560135,  0.78826934,  -0.18788454, 0.38178417,
          0.9748209,  1.0242884,   0.7939937,   0.24449475,  -1.3840157,
          1.9665064,  0.35833818,  -0.87076694, -0.76727265, 0.6157508,
          -0.5558823, 0.18417479,  -0.93904793, -0.00859687, 0.5034271,
        ]));
    const output = nn.mul(a, b);
    const model = await nn.createModel([{name: 'output', operand: output}]);
    const compilation = await model.createCompilation();
    const execution = await compilation.createExecution();
    execution.setInput(
        'a', new Float32Array([
          5.6232101e-01,  1.3117781e-01,  -1.4161869e+00, 2.0386910e-02,
          9.1077393e-01,  7.4952751e-01,  -2.8509337e-01, -1.6272701e+00,
          1.0271618e+00,  4.2815253e-01,  -7.7895027e-01, 9.7542489e-01,
          3.9352554e-01,  9.7878903e-01,  -6.0965502e-01, 6.6299748e-01,
          -1.1980454e+00, -7.7857232e-01, -9.8175555e-01, -2.8763762e-01,
          -3.2260692e-01, -7.4259090e-01, -1.0055183e+00, -1.4305019e+00,
          6.0624069e-01,  -1.5911928e-01, 4.5598033e-01,  1.0880016e-01,
          1.4949993e+00,  6.6210419e-01,  -5.6889033e-01, -2.0945708e-01,
          -7.1049523e-01, -2.8507587e-01, 1.1723405e+00,  -6.3937567e-02,
          -5.4250038e-01, -1.2398884e+00, -1.0347517e+00, 1.2763804e+00,
          -1.5979607e+00, -5.8152825e-01, -5.0100851e-01, -1.0742084e+00,
          -1.1273566e+00, 3.4815140e-04,  -5.6024802e-01, 1.0848801e+00,
          -5.1780093e-01, -3.8996863e-01, 5.3133094e-01,  2.3897937e-01,
          -1.3832775e+00, 6.3414145e-01,  1.0691971e+00,  5.7040757e-01,
          3.0711100e-01,  8.8405716e-01,  -2.1583509e+00, 4.3243581e-01,
        ]));
    const outputBuffer = new Float32Array(60);
    execution.setOutput('output', outputBuffer);
    await execution.startCompute();
    const expected = [
      1.1491189e+00,  9.4631165e-03,  1.6490275e+00,  -2.4890469e-02,
      8.1811851e-01,  1.6337387e-01,  -7.8853898e-02, -1.2602202e+00,
      -5.3575772e-01, -4.1527072e-01, -4.7369415e-01, -4.1217282e-02,
      1.2889189e-01,  -6.3069537e-02, 1.3762078e+00,  1.1803139e+00,
      1.5325792e+00,  2.4438977e+00,  1.1451044e+00,  2.2863047e-01,
      -2.1905430e-01, -8.1083733e-01, -5.2191615e-01, -1.8863121e+00,
      4.0087774e-01,  -6.4828001e-02, 2.3747511e-02,  1.8004529e-02,
      -6.8329555e-01, 6.7199409e-02,  -4.6930403e-02, -8.3616674e-02,
      2.8035283e-01,  1.0658713e-01,  1.7303753e+00,  4.9952760e-02,
      2.6594621e-01,  -3.3502471e-01, 2.4387409e-01,  1.7674020e-01,
      -1.5608643e+00, 7.8856015e-01,  -3.9492965e-01, 2.0182715e-01,
      -4.3040693e-01, 3.3938527e-04,  -5.7385558e-01, 8.6138797e-01,
      -1.2659961e-01, 5.3972268e-01,  1.0448657e+00,  8.5635431e-02,
      1.2045124e+00,  -4.8655939e-01, 6.5835893e-01,  -3.1707945e-01,
      5.6562103e-02,  -8.3017206e-01, 1.8555066e-02,  2.1769990e-01,
    ];
    checkOutput(outputBuffer, expected);
  }, "Mul: Compute the element-wise binary multiplication with two input tensors, one input tensors is a constant.");

  promise_test(async t => {
    const a = nn.input('a', {type: 'tensor-float32', dimensions: [3, 4, 5]});
    const b = nn.input('b', {type: 'tensor-float32', dimensions: [3, 4, 5]});
    const output = nn.mul(a, b);
    const model = await nn.createModel([{name: 'output', operand: output}]);
    const compilation = await model.createCompilation();
    const execution = await compilation.createExecution();
    execution.setInput(
        'a', new Float32Array([
          2.0435283,  0.07213961,  -1.1644137,  -1.2209045,  0.8982674,
          0.21796915, 0.27658972,  0.7744382,   -0.52159035, -0.969913,
          0.6081186,  -0.04225572, 0.3275312,   -0.06443629, -2.257355,
          1.7802691,  -1.279233,   -3.1389477,  -1.1663845,  -0.79485595,
          0.679013,   1.0919031,   0.51905185,  1.3186365,   0.6612518,
          0.40741763, 0.05208012,  0.16548257,  -0.4570541,  0.10149371,
          0.08249464, 0.3992067,   -0.3945879,  -0.37389037, 1.4760005,
          -0.781274,  -0.49022308, 0.27020553,  -0.2356837,  0.13846985,
          0.9767852,  -1.3560135,  0.78826934,  -0.18788454, 0.38178417,
          0.9748209,  1.0242884,   0.7939937,   0.24449475,  -1.3840157,
          1.9665064,  0.35833818,  -0.87076694, -0.76727265, 0.6157508,
          -0.5558823, 0.18417479,  -0.93904793, -0.00859687, 0.5034271,
        ]));
    execution.setInput(
        'b', new Float32Array([
          5.6232101e-01,  1.3117781e-01,  -1.4161869e+00, 2.0386910e-02,
          9.1077393e-01,  7.4952751e-01,  -2.8509337e-01, -1.6272701e+00,
          1.0271618e+00,  4.2815253e-01,  -7.7895027e-01, 9.7542489e-01,
          3.9352554e-01,  9.7878903e-01,  -6.0965502e-01, 6.6299748e-01,
          -1.1980454e+00, -7.7857232e-01, -9.8175555e-01, -2.8763762e-01,
          -3.2260692e-01, -7.4259090e-01, -1.0055183e+00, -1.4305019e+00,
          6.0624069e-01,  -1.5911928e-01, 4.5598033e-01,  1.0880016e-01,
          1.4949993e+00,  6.6210419e-01,  -5.6889033e-01, -2.0945708e-01,
          -7.1049523e-01, -2.8507587e-01, 1.1723405e+00,  -6.3937567e-02,
          -5.4250038e-01, -1.2398884e+00, -1.0347517e+00, 1.2763804e+00,
          -1.5979607e+00, -5.8152825e-01, -5.0100851e-01, -1.0742084e+00,
          -1.1273566e+00, 3.4815140e-04,  -5.6024802e-01, 1.0848801e+00,
          -5.1780093e-01, -3.8996863e-01, 5.3133094e-01,  2.3897937e-01,
          -1.3832775e+00, 6.3414145e-01,  1.0691971e+00,  5.7040757e-01,
          3.0711100e-01,  8.8405716e-01,  -2.1583509e+00, 4.3243581e-01,
        ]));
    const outputBuffer = new Float32Array(60);
    execution.setOutput('output', outputBuffer);
    await execution.startCompute();
    const expected = [
      1.1491189e+00,  9.4631165e-03,  1.6490275e+00,  -2.4890469e-02,
      8.1811851e-01,  1.6337387e-01,  -7.8853898e-02, -1.2602202e+00,
      -5.3575772e-01, -4.1527072e-01, -4.7369415e-01, -4.1217282e-02,
      1.2889189e-01,  -6.3069537e-02, 1.3762078e+00,  1.1803139e+00,
      1.5325792e+00,  2.4438977e+00,  1.1451044e+00,  2.2863047e-01,
      -2.1905430e-01, -8.1083733e-01, -5.2191615e-01, -1.8863121e+00,
      4.0087774e-01,  -6.4828001e-02, 2.3747511e-02,  1.8004529e-02,
      -6.8329555e-01, 6.7199409e-02,  -4.6930403e-02, -8.3616674e-02,
      2.8035283e-01,  1.0658713e-01,  1.7303753e+00,  4.9952760e-02,
      2.6594621e-01,  -3.3502471e-01, 2.4387409e-01,  1.7674020e-01,
      -1.5608643e+00, 7.8856015e-01,  -3.9492965e-01, 2.0182715e-01,
      -4.3040693e-01, 3.3938527e-04,  -5.7385558e-01, 8.6138797e-01,
      -1.2659961e-01, 5.3972268e-01,  1.0448657e+00,  8.5635431e-02,
      1.2045124e+00,  -4.8655939e-01, 6.5835893e-01,  -3.1707945e-01,
      5.6562103e-02,  -8.3017206e-01, 1.8555066e-02,  2.1769990e-01,
    ];
    checkOutput(outputBuffer, expected);
  }, "Mul: Compute the element-wise binary multiplication with two input tensors.");

  promise_test(async t => {
    const a = nn.input('a', {type: 'tensor-float32', dimensions: [3, 4, 5]});
    const b = nn.input('b', {type: 'tensor-float32', dimensions: [5]});
    const output = nn.mul(a, b);
    const model = await nn.createModel([{name: 'output', operand: output}]);
    const compilation = await model.createCompilation();
    const execution = await compilation.createExecution();
    execution.setInput(
        'a', new Float32Array([
          -0.08539673, 0.11800674,  -1.2358714,  0.30089188,  -0.73443925,
          1.4894297,   0.16823359,  -2.2034893,  1.0740992,   -0.35457978,
          0.61524934,  0.462153,    0.5992003,   -0.81047946, -2.2757835,
          -0.21841764, 1.1650828,   -0.56927145, 1.9960726,   0.62048405,
          0.10586528,  -1.0386543,  -1.9402571,  -2.0906122,  -0.4305259,
          -1.2730165,  1.5639576,   0.53357494,  -0.8079486,  -0.06450062,
          -0.7841324,  -0.24135855, 1.9275267,   0.4476717,   0.15467685,
          -1.2363592,  -0.50745815, 0.03250425,  0.86344534,  -0.7938714,
          1.1835734,   1.515135,    0.3092435,   -1.311751,   -0.6659017,
          0.8815683,   -0.31157655, 0.57511795,  -1.1924151,  -1.8408557,
          -0.85080767, -1.3341717,  0.54687303,  -0.14426671, -0.15728855,
          0.323939,    1.167636,    0.03020451,  0.91373825,  1.0675793,
        ]));
    execution.setInput('b', new Float32Array([
                        0.6338172,
                        1.630534,
                        -1.3819867,
                        -1.0427561,
                        1.058136,
                      ]));
    const outputBuffer = new Float32Array(60);
    execution.setOutput('output', outputBuffer);
    await execution.startCompute();
    const expected = [
      -0.05412592, 0.192414,    1.707958,    -0.31375682, -0.7771366,
      0.9440262,   0.2743106,   3.045193,    -1.1200235,  -0.37519363,
      0.3899556,   0.7535562,   -0.82808685, 0.8451324,   -2.4080884,
      -0.13843685, 1.8997072,   0.7867256,   -2.0814168,  0.6565565,
      0.06709924,  -1.6935612,  2.6814096,   2.1799986,   -0.45555493,
      -0.80685973, 2.550086,    -0.7373935,  0.8424933,   -0.06825043,
      -0.4969966,  -0.39354333, -2.6638165,  -0.4668124,  0.16366914,
      -0.7836257,  -0.8274278,  -0.04492044, -0.9003629,  -0.8400239,
      0.75016916,  2.4704792,   -0.42737043, 1.3678364,   -0.7046146,
      0.55875313,  -0.5080362,  -0.79480535, 1.2433981,   -1.9478757,
      -0.5392565,  -2.1754124,  -0.7557713,  0.15043499,  -0.16643268,
      0.20531811,  1.9038703,   -0.04174223, -0.9528061,  1.129644,
    ];
    checkOutput(outputBuffer, expected);
  }, "Mul: Compute the element-wise binary multiplication with two input tensors whose dimensions are compatible.");

</script>
